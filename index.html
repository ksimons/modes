<html>
  <head></head>
  <body>
    <div id="root"></div>
    <script type="text/javascript">
      function rotate(arr, n) {
        return arr.slice(n, arr.length).concat(arr.slice(0, n));
      }

      const START_NOTE = "E";
      const START_OCTAVE = 2;
      const END_NOTE = "D";
      const END_OCTAVE = 6;

      const HALF_STEP = "H";
      const WHOLE_STEP = "W";

      const IONIAN_MODE = [
        WHOLE_STEP,
        WHOLE_STEP,
        HALF_STEP,
        WHOLE_STEP,
        WHOLE_STEP,
        WHOLE_STEP,
        HALF_STEP,
      ];

      const MODES = {
        IONIAN: IONIAN_MODE,
        DORIAN: rotate(IONIAN_MODE, 1),
        PHRYGIAN: rotate(IONIAN_MODE, 2),
        LYDIAN: rotate(IONIAN_MODE, 3),
        MIXOLYDIAN: rotate(IONIAN_MODE, 4),
        AEOLIAN: rotate(IONIAN_MODE, 5),
        LOCRIAN: rotate(IONIAN_MODE, 6),
      };

      const AUDIO_FILES = {};

      function incrementNote(note, octave, step) {
        const numberOfSharps = note.match(/#/g)?.length || 0;
        const baseNote = note.replace(/#/g, "");
        const upOctave = baseNote === "B";

        const newBaseNote =
          baseNote === "G"
            ? "A"
            : String.fromCharCode(baseNote.charCodeAt(0) + 1);
        const newNumberOfSharps =
          (baseNote === "B" || baseNote === "E" ? -1 : -2) +
          numberOfSharps +
          (step === WHOLE_STEP ? 2 : 1);

        return {
          note: `${newBaseNote}${"#".repeat(newNumberOfSharps)}`,
          octave: upOctave ? octave + 1 : octave,
        };
      }

      function generateMode(mode, startingNode, startingOctave, noteCount) {
        let currentNote = startingNode;
        let currentOctave = startingOctave;
        let notes = [];
        for (let i = 0; i < noteCount; i++) {
          notes.push({ note: currentNote, octave: currentOctave });
          const step = mode[i % mode.length];
          const nextNote = incrementNote(currentNote, currentOctave, step);
          currentNote = nextNote.note;
          currentOctave = nextNote.octave;
        }
        return notes;
      }

      function canonicalNoteName(note, octave) {
        const baseNote = note.replace(/#/g, "");
        let isSharp = note.includes("#");
        const isDoubleSharp = note.includes("##");

        let canonicalNote = baseNote;
        let newOctave = octave;

        if (isSharp) {
          if (baseNote === "B") {
            canonicalNote = "C";
            isSharp = false;
            newOctave++;
          } else if (baseNote === "E") {
            canonicalNote = "F";
            isSharp = false;
          } else if (isDoubleSharp) {
            canonicalNote =
              baseNote === "G"
                ? "A"
                : String.fromCharCode(baseNote.charCodeAt(0) + 1);
            isSharp = false;
          }
        }

        return {
          note: `${canonicalNote}${isSharp ? "#" : ""}`,
          octave: newOctave,
        };
      }

      function toFileName(note, octave) {
        const { note: newNote, octave: newOctave } = canonicalNoteName(
          note,
          octave
        );

        return `notes/${newNote.replace(/#/g, "-sharp")}${newOctave}.mp3`;
      }

      function loadAudioFiles() {
        const notes = [
          "C",
          "C#",
          "D",
          "D#",
          "E",
          "F",
          "F#",
          "G",
          "G#",
          "A",
          "A#",
          "B",
        ];

        let currentNote = START_NOTE;
        let currentOctave = START_OCTAVE;

        while (true) {
          const fileName = toFileName(currentNote, currentOctave);
          const audio = new Audio(fileName);
          audio.preload = "auto";
          AUDIO_FILES[`${currentNote}${currentOctave}`] = audio;
          if (currentNote === END_NOTE && currentOctave === END_OCTAVE) {
            break;
          }
          currentOctave =
            currentNote === "B" ? currentOctave + 1 : currentOctave;
          currentNote = notes[(notes.indexOf(currentNote) + 1) % notes.length];
        }
      }

      function metronome(bpm, callback) {
        const interval = 60000 / bpm;
        const intervalId = setInterval(callback, interval);
        return () => clearInterval(intervalId);
      }

      let stopMetronome = null;

      function getNotes() {
        const mode = document.getElementById("mode").value;
        const startingNote = document.getElementById("startingNote").value;
        const startingOctave = parseInt(
          document.getElementById("startingOctave").value
        );
        const noteCount = parseInt(document.getElementById("noteCount").value);
        return generateMode(
          MODES[mode],
          startingNote,
          startingOctave,
          noteCount
        );
      }

      function updateMode() {
        stop();

        const notes = getNotes()
          .slice(0, 8)
          .map((note) => note.note.replace(/\d/g, ""));
        const notesElement = document.getElementById("notes");
        notesElement.innerHTML = notes.join(" ");

        const modeValue = document.getElementById("mode").value;
        const mode = MODES[modeValue];
      }

      function play() {
        stop();

        const bpm = parseInt(document.getElementById("bpm").value);
        const notes = getNotes();

        let index = 0;
        stopMetronome = metronome(bpm, () => {
          const { note, octave } = canonicalNoteName(
            notes[index].note,
            notes[index].octave
          );
          const audio = AUDIO_FILES[`${note}${octave}`];
          if (audio) {
            audio.play();
            setTimeout(() => {
              audio.pause();
              audio.currentTime = 0;
            }, 60000 / (bpm * 2));
          }

          const noteElement = document.getElementById("note");
          noteElement.innerHTML = `${notes[index].note}${notes[index].octave}`;
          index = (index + 1) % notes.length;
        });
      }

      function stop() {
        if (stopMetronome) {
          stopMetronome();
          stopMetronome = null;
        }
        const noteElement = document.getElementById("note");
        noteElement.innerHTML = "";
      }
    </script>
    <form onsubmit="return false;">
      <label for="bpm">BPM</label>
      <input type="number" id="bpm" value="60" />
      <label for="mode">Mode</label>
      <select id="mode" onchange="updateMode()">
        <option value="IONIAN">Ionian</option>
        <option value="DORIAN">Dorian</option>
        <option value="PHRYGIAN">Phrygian</option>
        <option value="LYDIAN">Lydian</option>
        <option value="MIXOLYDIAN">Mixolydian</option>
        <option value="AEOLIAN">Aeolian</option>
        <option value="LOCRIAN">Locrian</option>
      </select>
      <label for="startingNote">Starting Note</label>
      <select id="startingNote" onchange="updateMode()">
        <option value="C">C</option>
        <option value="C#">C#</option>
        <option value="D">D</option>
        <option value="D#">D#</option>
        <option value="E">E</option>
        <option value="F">F</option>
        <option value="F#">F#</option>
        <option value="G" selected="selected">G</option>
        <option value="G#">G#</option>
        <option value="A">A</option>
        <option value="A#">A#</option>
        <option value="B">B</option>
      </select>
      <label for="startingOctave">Starting Octave</label>
      <input type="number" id="startingOctave" value="2" min="2" max="6" />
      <label for="noteCount">Note Count</label>
      <input type="number" id="noteCount" value="18" min="1" max="24" />
      <button id="start" onclick="play()" disabled="true">Start</button>
      <button onclick="stop()">Stop</button>
      <div id="intervals"></div>
      <div id="notes"></div>
      <div id="note"></div>
    </form>

    <script>
      loadAudioFiles();
      updateMode();
      document.getElementById("start").disabled = false;
    </script>
  </body>
</html>
